using UnityEngine;
using UnityEditor;
using System.IO;

public class AutoPrefabExporter : EditorWindow {
    private const string rootObjectName = "Human";

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆèµ·å‹•æ™‚ã«EditorPrefsã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã‚‹ï¼‰
    public static string prefabFolderInAssets = "Assets/AutoGeneratedPrefabs";
    public static string packageOutputDirectory = "";
    public static string packageFileName = "ExportedPackage.unitypackage";

    [MenuItem("Tools/Auto Export Prefab Window")]
    public static void ShowWindow() {
        GetWindow<AutoPrefabExporter>("Auto Prefab Exporter");
    }

    void OnEnable() {
        // EditorPrefsã‹ã‚‰å‰å›ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
        prefabFolderInAssets = EditorPrefs.GetString("AutoExport_PrefabFolder", "Assets/AutoGeneratedPrefabs");
        packageOutputDirectory = EditorPrefs.GetString("AutoExport_PackageFolder", "");
        packageFileName = EditorPrefs.GetString("AutoExport_FileName", "ExportedPackage.unitypackage");
    }

    void OnGUI() {
        GUILayout.Label("Prefabå‡ºåŠ›ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ï¼‰", EditorStyles.boldLabel);
        string newPrefabPath = EditorGUILayout.TextField("Prefabãƒ•ã‚©ãƒ«ãƒ€ï¼ˆAssetså†…ï¼‰", prefabFolderInAssets);
        if (newPrefabPath != prefabFolderInAssets) {
            prefabFolderInAssets = newPrefabPath;
            EditorPrefs.SetString("AutoExport_PrefabFolder", prefabFolderInAssets);
        }

        GUILayout.Space(10);
        GUILayout.Label("UnityPackage å‡ºåŠ›å…ˆï¼ˆçµ¶å¯¾ãƒ‘ã‚¹ï¼‰", EditorStyles.boldLabel);

        EditorGUILayout.BeginHorizontal();
        EditorGUILayout.SelectableLabel(packageOutputDirectory, GUILayout.Height(16));
        if (GUILayout.Button("ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ", GUILayout.Width(100))) {
            string selected = EditorUtility.OpenFolderPanel("unitypackageã®å‡ºåŠ›å…ˆã‚’é¸æŠ", Application.dataPath, "");
            if (!string.IsNullOrEmpty(selected)) {
                packageOutputDirectory = selected;
                EditorPrefs.SetString("AutoExport_PackageFolder", packageOutputDirectory);
            }
        }
        EditorGUILayout.EndHorizontal();

        string newFileName = EditorGUILayout.TextField("ãƒ•ã‚¡ã‚¤ãƒ«å", packageFileName);
        if (newFileName != packageFileName) {
            packageFileName = newFileName;
            EditorPrefs.SetString("AutoExport_FileName", packageFileName);
        }

        GUILayout.Space(20);
        if (GUILayout.Button("ğŸš€ Export Prefab & UnityPackage")) {
            Export();
        }
    }

    public static void Export() {
        GameObject target = GameObject.Find(rootObjectName);
        if (target == null) {
            Debug.LogError($"ãƒ’ã‚¨ãƒ©ãƒ«ã‚­ãƒ¼ã« '{rootObjectName}' ã¨ã„ã†åå‰ã®GameObjectãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }

        // ãƒ—ãƒ¬ãƒãƒ–ä¿å­˜
        if (!Directory.Exists(prefabFolderInAssets)) {
            Directory.CreateDirectory(prefabFolderInAssets);
        }

        string prefabPath = $"{prefabFolderInAssets}/{target.name}.prefab";
        PrefabUtility.SaveAsPrefabAssetAndConnect(target, prefabPath, InteractionMode.UserAction);
        PrefabUtility.UnpackPrefabInstance(target, PrefabUnpackMode.Completely, InteractionMode.UserAction);

        // unitypackageä¿å­˜
        if (string.IsNullOrEmpty(packageOutputDirectory) || !Directory.Exists(packageOutputDirectory)) {
            Debug.LogError("UnityPackageã®å‡ºåŠ›å…ˆãƒ•ã‚©ãƒ«ãƒ€ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            return;
        }

        string fullExportPath = Path.Combine(packageOutputDirectory, packageFileName);
        AssetDatabase.ExportPackage(prefabFolderInAssets, fullExportPath, ExportPackageOptions.Recurse);

        Debug.Log($"Exportå®Œäº†\n- Prefab: {prefabPath}\n- UnityPackage: {fullExportPath}");
    }
}
