using UnityEngine;
using UnityEditor;
using System.IO;

public class AutoPrefabExporter : EditorWindow {
    private const string rootObjectName = "RootObject";
    private string exportFolder = "Assets/AutoGeneratedPrefabs"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºåŠ›å…ˆ
    private string packageFileName = "ExportedPackage.unitypackage";

    [MenuItem("Tools/Auto Export Prefab Window")]
    public static void ShowWindow() {
        GetWindow<AutoPrefabExporter>("Auto Prefab Exporter");
    }

    void OnGUI() {
        GUILayout.Label("å‡ºåŠ›è¨­å®š", EditorStyles.boldLabel);

        EditorGUILayout.BeginHorizontal();
        EditorGUILayout.LabelField("å‡ºåŠ›å…ˆãƒ•ã‚©ãƒ«ãƒ€:", GUILayout.Width(100));
        EditorGUILayout.SelectableLabel(exportFolder, GUILayout.Height(16));
        if (GUILayout.Button("ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ", GUILayout.Width(100))) {
            string selected = EditorUtility.OpenFolderPanel("å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ", Application.dataPath, "");
            if (!string.IsNullOrEmpty(selected)) {
                if (selected.StartsWith(Application.dataPath)) {
                    exportFolder = "Assets" + selected.Substring(Application.dataPath.Length);
                } else {
                    EditorUtility.DisplayDialog("ã‚¨ãƒ©ãƒ¼", "Assets ãƒ•ã‚©ãƒ«ãƒ€ä»¥ä¸‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", "OK");
                }
            }
        }
        EditorGUILayout.EndHorizontal();

        packageFileName = EditorGUILayout.TextField("Packageãƒ•ã‚¡ã‚¤ãƒ«å", packageFileName);

        GUILayout.Space(20);

        if (GUILayout.Button("ğŸš€ Export Prefab & UnityPackage")) {
            Export();
        }
    }

    void Export() {
        GameObject target = GameObject.Find(rootObjectName);
        if (target == null) {
            Debug.LogError($"ãƒ’ã‚¨ãƒ©ãƒ«ã‚­ãƒ¼ã« '{rootObjectName}' ã¨ã„ã†åå‰ã®GameObjectãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }

        if (!Directory.Exists(exportFolder)) {
            Directory.CreateDirectory(exportFolder);
        }

        string prefabPath = $"{exportFolder}/{target.name}.prefab";
        PrefabUtility.SaveAsPrefabAssetAndConnect(target, prefabPath, InteractionMode.UserAction);
        PrefabUtility.UnpackPrefabInstance(target, PrefabUnpackMode.Completely, InteractionMode.UserAction);

        string exportPath = Path.Combine(exportFolder, packageFileName);
        AssetDatabase.ExportPackage(exportFolder, exportPath, ExportPackageOptions.Recurse);

        Debug.Log($"Prefabã¨UnityPackageã®å‡ºåŠ›ãŒå®Œäº†ï¼š\n- Prefab: {prefabPath}\n- Package: {exportPath}");
    }
}
