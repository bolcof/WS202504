using UnityEngine;
using UnityEditor;
using System.IO;

public class AutoPrefabExporter : EditorWindow {
    private const string rootObjectName = "Human";

    private string prefabFolderInAssets = "Assets/AutoGeneratedPrefabs";
    private string packageOutputDirectory = ""; // 絶対パスで設定
    private string packageFileName = "ExportedPackage.unitypackage";

    [MenuItem("Tools/Auto Export Prefab Window")]
    public static void ShowWindow() {
        GetWindow<AutoPrefabExporter>("Auto Prefab Exporter");
    }

    void OnGUI() {
        GUILayout.Label("Prefab出力（プロジェクト内）", EditorStyles.boldLabel);
        prefabFolderInAssets = EditorGUILayout.TextField("Prefabフォルダ（Assets内）", prefabFolderInAssets);

        GUILayout.Space(10);
        GUILayout.Label("UnityPackage 出力先（絶対パス）", EditorStyles.boldLabel);

        EditorGUILayout.BeginHorizontal();
        EditorGUILayout.SelectableLabel(packageOutputDirectory, GUILayout.Height(16));
        if (GUILayout.Button("フォルダ選択", GUILayout.Width(100))) {
            string selected = EditorUtility.OpenFolderPanel("unitypackageの出力先を選択", Application.dataPath, "");
            if (!string.IsNullOrEmpty(selected)) {
                packageOutputDirectory = selected;
            }
        }
        EditorGUILayout.EndHorizontal();

        packageFileName = EditorGUILayout.TextField("ファイル名", packageFileName);

        GUILayout.Space(20);
        if (GUILayout.Button("🚀 Export Prefab & UnityPackage")) {
            Export();
        }
    }

    void Export() {
        GameObject target = GameObject.Find(rootObjectName);
        if (target == null) {
            Debug.LogError($"ヒエラルキーに '{rootObjectName}' という名前のGameObjectが見つかりません。");
            return;
        }

        // プレハブ保存
        if (!Directory.Exists(prefabFolderInAssets)) {
            Directory.CreateDirectory(prefabFolderInAssets);
        }

        string prefabPath = $"{prefabFolderInAssets}/{target.name}.prefab";
        PrefabUtility.SaveAsPrefabAssetAndConnect(target, prefabPath, InteractionMode.UserAction);
        PrefabUtility.UnpackPrefabInstance(target, PrefabUnpackMode.Completely, InteractionMode.UserAction);

        // unitypackage保存
        if (string.IsNullOrEmpty(packageOutputDirectory) || !Directory.Exists(packageOutputDirectory)) {
            Debug.LogError("UnityPackageの出力先フォルダが正しく設定されていません。");
            return;
        }

        string fullExportPath = Path.Combine(packageOutputDirectory, packageFileName);
        AssetDatabase.ExportPackage(prefabFolderInAssets, fullExportPath, ExportPackageOptions.Recurse);

        Debug.Log($"Export完了\n- Prefab: {prefabPath}\n- UnityPackage: {fullExportPath}");
    }
}
