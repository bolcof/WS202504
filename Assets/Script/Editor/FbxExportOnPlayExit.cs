#if UNITY_EDITOR
using UnityEditor;
using UnityEditor.Formats.Fbx.Exporter;
using UnityEngine;
using System.IO;

[InitializeOnLoad]
public static class FbxExportOnPlayExit {
    private const string rootObjectName = "Human";

    // デフォルト値（起動時にEditorPrefsから読み込まれる）
    public static string exportFolderInAssets = "Assets/AutoGeneratedPrefabs";
    public static string fbxOutputDirectory = "";
    public static string fbxFileName = "ExportedPackage2.unitypackage";

    static FbxExportOnPlayExit() {
        EditorApplication.playModeStateChanged += OnPlayModeChanged;
    }

    static void OnPlayModeChanged(PlayModeStateChange state) {
        if (state == PlayModeStateChange.EnteredEditMode) {
            if (PlayerPrefs.GetInt("ExportFBXRequest", 0) == 1) {
                PlayerPrefs.SetInt("ExportFBXRequest", 0);
                PlayerPrefs.Save();

                GameObject target = GameObject.Find(rootObjectName);
                if (target != null) {
                    string folder = fbxOutputDirectory;
                    string baseName = Path.GetFileNameWithoutExtension(fbxFileName);
                    string fullPath = Path.Combine(folder, baseName + ".fbx");

                    ModelExporter.ExportObject(fullPath, target);
                    Debug.Log($"✅ FBX書き出し完了: {fullPath}");
                } else {
                    Debug.LogError("GameObject 'Human' が見つかりませんでした。");
                }
            }
        }
    }
}
#endif